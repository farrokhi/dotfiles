#!/bin/bash
 
[[ $# -lt 1 ]] && exit 1
 
tooMuchMem="${1}"
shift
 
/bin/mkdir -p ~/var/run 1>/dev/null 2>&1
 
base="${0##*/}"
lockf=~/var/run/${base}.lock
 
quit() {
  /bin/rm -f ${lockf}
  exit ${1}
}
 
trap "quit 1" 1 2 3 15
 
/usr/bin/lockfile -1 -r0 ${lockf} 1>/dev/null 2>&1 || exit 1
 
oldIFS="${IFS}"
IFS=:
/usr/bin/vm_stat 2>/dev/null \
| while read header mem
  do
    case "${header}" in
    Pages\ inactive)
      IFS="${oldIFS}"
      mem="$(echo "${mem}" | /usr/bin/sed -e 's/\.//g' -e 's/  *//g')"
      [[ ${mem} -gt ${tooMuchMem} ]] && {
        /bin/echo -n "purging due to ${mem} inactive memory blocks > ${tooMuchMem} ..."
        /usr/bin/purge
        /bin/echo " done"
      }
      break
      ;;
    esac
  done 2>/dev/null

sync
sync
quit 0
